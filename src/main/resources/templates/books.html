<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title th:text="#{navbar.books} + ' - BookStore'">Books - BookStore</title>
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <style>
        .book-card.deleted-book {
            opacity: 0.6;
            border: 2px dashed #dc3545;
            position: relative;
        }
        .deleted-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #dc3545;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            z-index: 10;
        }
        .restore-button {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background-color: #28a745;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.85rem;
            z-index: 10;
        }
        .restore-button:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>

<!-- Navbar -->
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="content-wrapper">

    <div class="header">
        <h1 th:text="#{books.title}">Book Catalog</h1>
        <a href="/books/manage/add"
           class="btn-add"
           sec:authorize="hasAnyRole('EMPLOYEE','ADMIN')"
           th:text="#{books.addNew}">
            Add New Book
        </a>
    </div>

    <!-- Search and Filter Form -->
    <form class="search-form" method="get" action="/books">
        <div class="form-row">
            <div class="form-group search-box">
                <label for="searchQuery" th:text="#{books.search}">Search</label>
                <input type="text"
                       id="searchQuery"
                       name="searchQuery"
                       th:value="${param.searchQuery}"
                       th:placeholder="#{books.search.placeholder}">
            </div>

            <div class="form-group">
                <label for="genre" th:text="#{books.filter.genre}">Genre</label>
                <select id="genre" name="genre">
                    <option value="" th:text="#{books.filter.genre.all}">All Genres</option>
                    <option th:each="genre : ${genres}"
                            th:value="${genre}"
                            th:text="${genre}"
                            th:selected="${param.genre != null && param.genre[0] == genre}">
                    </option>
                </select>
            </div>

            <div class="form-group">
                <label for="language" th:text="#{books.filter.language}">Language</label>
                <select id="language" name="language">
                    <option value="" th:text="#{books.filter.language.all}">All Languages</option>
                    <option th:each="lang : ${languages}"
                            th:value="${lang.name()}"
                            th:text="${#strings.capitalizeWords(#strings.toLowerCase(#strings.replace(lang.name(), '_', ' ')))}"
                            th:selected="${param.language != null && param.language[0] == lang.name()}">
                    </option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="minPrice" th:text="#{books.filter.minPrice}">Min Price ($)</label>
                <input type="number"
                       id="minPrice"
                       name="minPrice"
                       th:value="${param.minPrice}"
                       min="0"
                       step="0.01"
                       th:placeholder="#{books.filter.minPrice.placeholder}">
            </div>

            <div class="form-group">
                <label for="maxPrice" th:text="#{books.filter.maxPrice}">Max Price ($)</label>
                <input type="number"
                       id="maxPrice"
                       name="maxPrice"
                       th:value="${param.maxPrice}"
                       min="0"
                       step="0.01"
                       th:placeholder="#{books.filter.maxPrice.placeholder}">
            </div>

            <div class="form-group">
                <label for="ageGroup" th:text="#{books.filter.ageGroup}">Age Group</label>
                <select id="ageGroup" name="ageGroup">
                    <option value="" th:text="#{books.filter.ageGroup.all}">All Ages</option>
                    <option th:each="age : ${ageGroups}"
                            th:value="${age.name()}"
                            th:text="${#strings.capitalizeWords(#strings.toLowerCase(#strings.replace(age.name(), '_', ' ')))}"
                            th:selected="${param.ageGroup != null && param.ageGroup[0] == age.name()}">
                    </option>
                </select>
            </div>

            <div class="form-group">
                <label for="sort" th:text="#{books.filter.sort}">Sort By</label>
                <select id="sort" name="sort">
                    <option value="id,asc" th:selected="${param.sort != null && param.sort[0] == 'id,asc'}"
                            th:text="#{books.filter.sort.newestFirst}">Newest First</option>
                    <option value="id,desc" th:selected="${param.sort != null && param.sort[0] == 'id,desc'}"
                            th:text="#{books.filter.sort.oldestFirst}">Oldest First</option>
                    <option value="name,asc" th:selected="${param.sort != null && param.sort[0] == 'name,asc'}"
                            th:text="#{books.filter.sort.nameAsc}">Name (A-Z)</option>
                    <option value="name,desc" th:selected="${param.sort != null && param.sort[0] == 'name,desc'}"
                            th:text="#{books.filter.sort.nameDesc}">Name (Z-A)</option>
                    <option value="price,asc" th:selected="${param.sort != null && param.sort[0] == 'price,asc'}"
                            th:text="#{books.filter.sort.priceAsc}">Price (Low to High)</option>
                    <option value="price,desc" th:selected="${param.sort != null && param.sort[0] == 'price,desc'}"
                            th:text="#{books.filter.sort.priceDesc}">Price (High to Low)</option>
                    <option value="author,asc" th:selected="${param.sort != null && param.sort[0] == 'author,asc'}"
                            th:text="#{books.filter.sort.authorAsc}">Author (A-Z)</option>
                    <option value="author,desc" th:selected="${param.sort != null && param.sort[0] == 'author,desc'}"
                            th:text="#{books.filter.sort.authorDesc}">Author (Z-A)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="size" th:text="#{books.filter.itemsPerPage}">Items Per Page</label>
                <select id="size" name="size">
                    <option value="6" th:selected="${param.size != null && param.size[0] == '6'}">6</option>
                    <option value="10" th:selected="${param.size == null || param.size[0] == '10'}">10</option>
                    <option value="20" th:selected="${param.size != null && param.size[0] == '20'}">20</option>
                    <option value="50" th:selected="${param.size != null && param.size[0] == '50'}">50</option>
                </select>
            </div>
        </div>

        <div class="button-group">
            <button type="submit" class="btn-search" th:text="#{books.button.search}">Search</button>
            <button type="button" class="btn-reset" onclick="window.location.href='/books'"
                    th:text="#{books.button.reset}">Reset Filters</button>
        </div>

        <input type="hidden" name="page" value="0">
    </form>

    <!-- Book list -->
    <div th:if="${books.content.size() > 0}">
        <div class="book-grid">
            <!-- For CLIENT: show only non-deleted books -->
            <th:block sec:authorize="hasRole('CLIENT')">
                <a th:each="book : ${books.content}"
                   th:if="!${book.deleted}"
                   th:href="@{'/books/' + ${book.name}}"
                   class="book-card">
                    <div class="book-title" th:text="${book.name}">Book Title</div>
                    <div class="book-author">
                        <span th:text="#{common.by}">by</span>
                        <span th:text="${book.author}">Author</span>
                    </div>
                    <div class="book-meta">
                        <span class="meta-tag" th:text="${book.genre}">Genre</span>
                        <span class="meta-tag">
                            <span th:text="${book.pages}">Pages</span>
                            <span th:text="#{common.pages}">pages</span>
                        </span>
                    </div>
                    <div class="book-price" th:text="'$' + ${#numbers.formatDecimal(book.price, 1, 2)}">$0.00</div>
                    <div class="book-description" th:text="${book.description}">Description...</div>
                </a>
            </th:block>

            <!-- For EMPLOYEE or ADMIN: show all books, mark deleted ones -->
            <th:block sec:authorize="hasAnyRole('EMPLOYEE','ADMIN')">
                <div th:each="book : ${books.content}"
                     class="book-card"
                     th:classappend="${book.deleted} ? 'deleted-book' : ''">

                    <span th:if="${book.deleted}" class="deleted-badge" th:text="#{books.badge.deleted}">DELETED</span>

                    <a th:href="@{'/books/' + ${book.name}}" style="text-decoration: none; color: inherit; display: block;">
                        <div class="book-title" th:text="${book.name}">Book Title</div>
                        <div class="book-author">
                            <span th:text="#{common.by}">by</span>
                            <span th:text="${book.author}">Author</span>
                        </div>
                        <div class="book-meta">
                            <span class="meta-tag" th:text="${book.genre}">Genre</span>
                            <span class="meta-tag">
                                <span th:text="${book.pages}">Pages</span>
                                <span th:text="#{common.pages}">pages</span>
                            </span>
                        </div>
                        <div class="book-price" th:text="'$' + ${#numbers.formatDecimal(book.price, 1, 2)}">$0.00</div>
                        <div class="book-description" th:text="${book.description}">Description...</div>
                    </a>

                    <form th:if="${book.deleted}"
                          th:action="@{'/books/' + ${book.name} + '/restore'}"
                          method="post"
                          style="display: inline;"
                          onclick="event.stopPropagation();">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button type="submit" class="restore-button" th:text="#{books.button.restore}">Restore</button>
                    </form>
                </div>
            </th:block>

            <!-- For ANONYMOUS: show only non-deleted books -->
            <th:block sec:authorize="isAnonymous()">
                <a th:each="book : ${books.content}"
                   th:if="!${book.deleted}"
                   th:href="@{'/books/' + ${book.name}}"
                   class="book-card">
                    <div class="book-title" th:text="${book.name}">Book Title</div>
                    <div class="book-author">
                        <span th:text="#{common.by}">by</span>
                        <span th:text="${book.author}">Author</span>
                    </div>
                    <div class="book-meta">
                        <span class="meta-tag" th:text="${book.genre}">Genre</span>
                        <span class="meta-tag">
                            <span th:text="${book.pages}">Pages</span>
                            <span th:text="#{common.pages}">pages</span>
                        </span>
                    </div>
                    <div class="book-price" th:text="'$' + ${#numbers.formatDecimal(book.price, 1, 2)}">$0.00</div>
                    <div class="book-description" th:text="${book.description}">Description...</div>
                </a>
            </th:block>
        </div>
    </div>

    <!-- Empty state -->
    <div th:if="${books.content.size() == 0}" class="empty-state">
        <h2 th:text="#{books.empty.title}">No books found</h2>
        <p th:text="#{books.empty.message}">Try adjusting your search filters or browse all books.</p>
        <button type="button"
                class="btn-reset"
                onclick="window.location.href='/books'"
                th:text="#{books.empty.button}">
            Show All Books
        </button>
    </div>

    <!-- Pagination -->
    <div class="pagination" th:if="${books.totalPages > 1}">
        <!-- Previous Button -->
        <a th:href="@{/books(page=${books.number - 1}, size=${books.size}, sort=${param.sort}, genre=${param.genre}, language=${param.language}, ageGroup=${param.ageGroup}, minPrice=${param.minPrice}, maxPrice=${param.maxPrice}, searchQuery=${param.searchQuery})}"
           th:classappend="${books.first} ? 'disabled'"
           th:unless="${books.first}">
            ← <span th:text="#{books.pagination.previous}">Previous</span>
        </a>
        <span th:if="${books.first}" class="disabled">← <span th:text="#{books.pagination.previous}">Previous</span></span>

        <!-- Page Numbers -->
        <th:block th:each="i : ${#numbers.sequence(0, books.totalPages - 1)}">
            <a th:if="${i >= books.number - 2 && i <= books.number + 2}"
               th:href="@{/books(page=${i}, size=${books.size}, sort=${param.sort}, genre=${param.genre}, language=${param.language}, ageGroup=${param.ageGroup}, minPrice=${param.minPrice}, maxPrice=${param.maxPrice}, searchQuery=${param.searchQuery})}"
               th:text="${i + 1}"
               th:classappend="${i == books.number} ? 'active'">
            </a>
        </th:block>

        <!-- Next Button -->
        <a th:href="@{/books(page=${books.number + 1}, size=${books.size}, sort=${param.sort}, genre=${param.genre}, language=${param.language}, ageGroup=${param.ageGroup}, minPrice=${param.minPrice}, maxPrice=${param.maxPrice}, searchQuery=${param.searchQuery})}"
           th:classappend="${books.last} ? 'disabled'"
           th:unless="${books.last}">
            <span th:text="#{books.pagination.next}">Next</span> →
        </a>
        <span th:if="${books.last}" class="disabled"><span th:text="#{books.pagination.next}">Next</span> →</span>
    </div>

    <div class="pagination-info" th:if="${books.totalPages > 0}">
        <span th:text="#{books.pagination.showing(${books.number * books.size + 1}, ${books.number * books.size + books.numberOfElements}, ${books.totalElements})}">
            Showing X to Y of Z books
        </span>
    </div>

</div>

</body>
</html>