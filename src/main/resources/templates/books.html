<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Books - BookStore</title>
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <style>
        /* Стилі для видалених книг (тільки для Employee) */
        .book-card.deleted-book {
            opacity: 0.6;
            border: 2px dashed #dc3545;
            position: relative;
        }

        .deleted-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #dc3545;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            z-index: 10;
        }

        .restore-button {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background-color: #28a745;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.85rem;
            z-index: 10;
        }

        .restore-button:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>

<!-- Navbar -->
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="content-wrapper">

    <div class="header">
        <h1>Book Catalog</h1>
        <!-- Add Book button - ONLY for EMPLOYEE -->
        <a href="/books/manage/add"
           class="btn-add"
           sec:authorize="hasRole('EMPLOYEE')">
            Add New Book
        </a>
    </div>

    <form class="search-form" method="get" action="/books">
        <div class="form-row">
            <div class="form-group search-box">
                <label for="searchQuery">Search</label>
                <input type="text"
                       id="searchQuery"
                       name="searchQuery"
                       th:value="${param.searchQuery}"
                       placeholder="Search by title, author, or description...">
            </div>

            <div class="form-group">
                <label for="genre">Genre</label>
                <select id="genre" name="genre">
                    <option value="">All Genres</option>
                    <option th:each="genre : ${genres}"
                            th:value="${genre}"
                            th:text="${genre}"
                            th:selected="${param.genre != null && param.genre[0] == genre}">
                    </option>
                </select>
            </div>

            <div class="form-group">
                <label for="language">Language</label>
                <select id="language" name="language">
                    <option value="">All Languages</option>
                    <option th:each="lang : ${languages}"
                            th:value="${lang.name()}"
                            th:text="${#strings.capitalizeWords(#strings.toLowerCase(#strings.replace(lang.name(), '_', ' ')))}"
                            th:selected="${param.language != null && param.language[0] == lang.name()}">
                    </option>
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="minPrice">Min Price ($)</label>
                <input type="number"
                       id="minPrice"
                       name="minPrice"
                       th:value="${param.minPrice}"
                       min="0"
                       step="0.01"
                       placeholder="0.00">
            </div>

            <div class="form-group">
                <label for="maxPrice">Max Price ($)</label>
                <input type="number"
                       id="maxPrice"
                       name="maxPrice"
                       th:value="${param.maxPrice}"
                       min="0"
                       step="0.01"
                       placeholder="999.99">
            </div>

            <div class="form-group">
                <label for="ageGroup">Age Group</label>
                <select id="ageGroup" name="ageGroup">
                    <option value="">All Ages</option>
                    <option th:each="age : ${ageGroups}"
                            th:value="${age.name()}"
                            th:text="${#strings.capitalizeWords(#strings.toLowerCase(#strings.replace(age.name(), '_', ' ')))}"
                            th:selected="${param.ageGroup != null && param.ageGroup[0] == age.name()}">
                    </option>
                </select>
            </div>

            <div class="form-group">
                <label for="sort">Sort By</label>
                <select id="sort" name="sort">
                    <option value="id,asc" th:selected="${param.sort != null && param.sort[0] == 'id,asc'}">Newest First</option>
                    <option value="id,desc" th:selected="${param.sort != null && param.sort[0] == 'id,desc'}">Oldest First</option>
                    <option value="name,asc" th:selected="${param.sort != null && param.sort[0] == 'name,asc'}">Name (A-Z)</option>
                    <option value="name,desc" th:selected="${param.sort != null && param.sort[0] == 'name,desc'}">Name (Z-A)</option>
                    <option value="price,asc" th:selected="${param.sort != null && param.sort[0] == 'price,asc'}">Price (Low to High)</option>
                    <option value="price,desc" th:selected="${param.sort != null && param.sort[0] == 'price,desc'}">Price (High to Low)</option>
                    <option value="author,asc" th:selected="${param.sort != null && param.sort[0] == 'author,asc'}">Author (A-Z)</option>
                    <option value="author,desc" th:selected="${param.sort != null && param.sort[0] == 'author,desc'}">Author (Z-A)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="size">Items Per Page</label>
                <select id="size" name="size">
                    <option value="6" th:selected="${param.size != null && param.size[0] == '6'}">6</option>
                    <option value="10" th:selected="${param.size == null || param.size[0] == '10'}">10</option>
                    <option value="20" th:selected="${param.size != null && param.size[0] == '20'}">20</option>
                    <option value="50" th:selected="${param.size != null && param.size[0] == '50'}">50</option>
                </select>
            </div>
        </div>

        <div class="button-group">
            <button type="submit" class="btn-search">Search</button>
            <button type="button" class="btn-reset" onclick="window.location.href='/books'">Reset Filters</button>
        </div>

        <input type="hidden" name="page" value="0">
    </form>

    <div th:if="${books.content.size() > 0}">
        <div class="book-grid">
            <!-- For CLIENT: show only non-deleted books -->
            <th:block sec:authorize="hasRole('CLIENT')">
                <a th:each="book : ${books.content}"
                   th:if="!${book.deleted}"
                   th:href="@{'/books/' + ${book.name}}"
                   class="book-card">
                    <div class="book-title" th:text="${book.name}">Book Title</div>
                    <div class="book-author" th:text="'by ' + ${book.author}">by Author</div>
                    <div class="book-meta">
                        <span class="meta-tag" th:text="${book.genre}">Genre</span>
                        <span class="meta-tag" th:text="${book.pages} + ' pages'">Pages</span>
                    </div>
                    <div class="book-price" th:text="'$' + ${#numbers.formatDecimal(book.price, 1, 2)}">$0.00</div>
                    <div class="book-description" th:text="${book.description}">Description...</div>
                </a>
            </th:block>

            <!-- For EMPLOYEE: show all books, mark deleted ones -->
            <th:block sec:authorize="hasRole('EMPLOYEE')">
                <div th:each="book : ${books.content}"
                     class="book-card"
                     th:classappend="${book.deleted} ? 'deleted-book' : ''">

                    <span th:if="${book.deleted}" class="deleted-badge">DELETED</span>

                    <a th:href="@{'/books/' + ${book.name}}" style="text-decoration: none; color: inherit; display: block;">
                        <div class="book-title" th:text="${book.name}">Book Title</div>
                        <div class="book-author" th:text="'by ' + ${book.author}">by Author</div>
                        <div class="book-meta">
                            <span class="meta-tag" th:text="${book.genre}">Genre</span>
                            <span class="meta-tag" th:text="${book.pages} + ' pages'">Pages</span>
                        </div>
                        <div class="book-price" th:text="'$' + ${#numbers.formatDecimal(book.price, 1, 2)}">$0.00</div>
                        <div class="book-description" th:text="${book.description}">Description...</div>
                    </a>

                    <form th:if="${book.deleted}"
                          th:action="@{'/books/' + ${book.name} + '/restore'}"
                          method="post"
                          style="display: inline;"
                          onclick="event.stopPropagation();">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button type="submit" class="restore-button">Restore</button>
                    </form>
                </div>
            </th:block>

            <!-- For ANONYMOUS: show only non-deleted books -->
            <th:block sec:authorize="isAnonymous()">
                <a th:each="book : ${books.content}"
                   th:if="!${book.deleted}"
                   th:href="@{'/books/' + ${book.name}}"
                   class="book-card">
                    <div class="book-title" th:text="${book.name}">Book Title</div>
                    <div class="book-author" th:text="'by ' + ${book.author}">by Author</div>
                    <div class="book-meta">
                        <span class="meta-tag" th:text="${book.genre}">Genre</span>
                        <span class="meta-tag" th:text="${book.pages} + ' pages'">Pages</span>
                    </div>
                    <div class="book-price" th:text="'$' + ${#numbers.formatDecimal(book.price, 1, 2)}">$0.00</div>
                    <div class="book-description" th:text="${book.description}">Description...</div>
                </a>
            </th:block>
        </div>
    </div>

    <div th:if="${books.content.size() == 0}" class="empty-state">
        <h2>No books found</h2>
        <p>Try adjusting your search filters or browse all books.</p>
        <button type="button"
                class="btn-reset"
                onclick="window.location.href='/books'">
            Show All Books
        </button>
    </div>

    <div class="pagination" th:if="${books.totalPages > 1}">
        <!-- Previous Button -->
        <a th:href="@{/books(page=${books.number - 1}, size=${books.size}, sort=${param.sort}, genre=${param.genre}, language=${param.language}, ageGroup=${param.ageGroup}, minPrice=${param.minPrice}, maxPrice=${param.maxPrice}, searchQuery=${param.searchQuery})}"
           th:classappend="${books.first} ? 'disabled'"
           th:unless="${books.first}">
            ← Previous
        </a>
        <span th:if="${books.first}" class="disabled">← Previous</span>

        <!-- Page Numbers (show max 5 pages) -->
        <th:block th:each="i : ${#numbers.sequence(0, books.totalPages - 1)}">
            <a th:if="${i >= books.number - 2 && i <= books.number + 2}"
               th:href="@{/books(page=${i}, size=${books.size}, sort=${param.sort}, genre=${param.genre}, language=${param.language}, ageGroup=${param.ageGroup}, minPrice=${param.minPrice}, maxPrice=${param.maxPrice}, searchQuery=${param.searchQuery})}"
               th:text="${i + 1}"
               th:classappend="${i == books.number} ? 'active'">
            </a>
        </th:block>

        <!-- Next Button -->
        <a th:href="@{/books(page=${books.number + 1}, size=${books.size}, sort=${param.sort}, genre=${param.genre}, language=${param.language}, ageGroup=${param.ageGroup}, minPrice=${param.minPrice}, maxPrice=${param.maxPrice}, searchQuery=${param.searchQuery})}"
           th:classappend="${books.last} ? 'disabled'"
           th:unless="${books.last}">
            Next →
        </a>
        <span th:if="${books.last}" class="disabled">Next →</span>
    </div>

    <div class="pagination-info" th:if="${books.totalPages > 0}">
        <span th:text="'Showing ' + ${books.number * books.size + 1} + ' to ' + ${books.number * books.size + books.numberOfElements} + ' of ' + ${books.totalElements} + ' books'"></span>
    </div>

</div>

</body>
</html>